[astpp-ani-map]
; Assigns accountcodes based on a number received.  This can be done using
; caller id numbers or pin codes.  The codes are assigned on the users page.
exten => _.X,1,AGI(astpp-ani-map.agi,${CALLERIDNUM})
exten => _.X,2,Set(CARDNUMER=${ACCOUNTCODE})
exten => _.X,2,Goto(astpp-callingcards,s,60)

[astpp-callingcards]
exten => s,1,Answer
exten => s,n,DeadAGI(astpp-callingcards.agi)
exten => s,n,GotoIf($["${NEWCALL}" = "1"]?60)
exten => s,n,GotoIf($["${BALANCE}" = "1"]?70)
exten => s,n,Hangup
exten => s,60,DeadAGI(astpp-callingcards.agi,${CARDNUMER})
exten => s,n,Hangup
exten => s,70,DeadAGI(astpp-callingcards.agi,${CARDNUMER},BALANCE)


[astpp-lcr]
; Number to dial derived from command-line.  Call script with the number
; to dial as the argument.  astpp-authorize will return a line containing info
; that will cut the call off before it goes over the users credit limit.  The
; user can get over credit limit if they have multiple calls going at once.
; Presently the only way to stop that is to limit them to one call which is not
; a nice solution.
;
;
exten => _1XXXXXXXXXX,1,AGI(astpp-lcr.agi,${EXTEN})
exten => _1XXXXXXXXXX,2,Dial(${LCRSTRING1})
exten => _1XXXXXXXXXX,3,ForkCDR
exten => _1XXXXXXXXXX,104,Busy
exten => _1XXXXXXXXXX,4,Dial(${LCRSTRING2})
exten => _1XXXXXXXXXX,5,ForkCDR
exten => _1XXXXXXXXXX,106,Busy
exten => _1XXXXXXXXXX,6,Dial(${LCRSTRING3})
exten => _1XXXXXXXXXX,7,ForkCDR
exten => _1XXXXXXXXXX,105,Busy
exten => _1XXXXXXXXXX,8,Dial(${LCRSTRING4})
exten => _1XXXXXXXXXX,9,ForkCDR
exten => _1XXXXXXXXXX,110,Busy
exten => _1XXXXXXXXXX,10,Dial(${LCRSTRING5})
exten => _1XXXXXXXXXX,11,ForkCDR
exten => _1XXXXXXXXXX,111,Busy


[astpp-outgoing]
; Card-number and number to dial derived from command-line.
; Call script with the card-number as first arg and the number
; to dial as the second arg.  astpp-authorize will return a line containing info
; that will cut the call off before it goes over the users credit limit.  The
; user can get over credit limit if they have multiple calls going at once.
; Presently the only way to stop that is to limit them to one call which is not
; a nice solution.
;
exten => _.X,1,AGI(astpp-authorize.agi,${ACCOUNTCODE},${EXTEN})
exten => _.X,2,GotoIf($["${CALLSTATUS}" = "0"]?60)
exten => _.X,3,GotoIf($["${CALLSTATUS}" = "1"]?70)
exten => _.X,4,GotoIf($["${CALLSTATUS}" = "2"]?80)
exten => _.X,5,Dial(${LCRSTRING1}${TIMELIMIT})
exten => _.X,6,ForkCDR
exten => _.X,107,Busy
exten => _.X,7,Dial(${LCRSTRING2}${TIMELIMIT})
exten => _.X,8,ForkCDR
exten => _.X,109,Busy
exten => _.X,9,Dial(${LCRSTRING3}${TIMELIMIT})
exten => _.X,10,ForkCDR
exten => _.X,111,Busy
exten => _.X,11,Dial(${LCRSTRING4}${TIMELIMIT})
exten => _.X,12,ForkCDR
exten => _.X,113,Busy
exten => _.X,13,Dial(${LCRSTRING5}${TIMELIMIT})
exten => _.X,14,ForkCDR
exten => _.X,1115,Busy
exten => _.X,60,Congestion ; '0' Tells them they do not have enough money
exten => _.X,61,Hangup
exten => _.X,70,Congestion '1' Bad Phone Number
exten => _.X,71,Hangup
exten => _.X,80,Congestion
exten => _.X,81,Hangup

[astpp-incoming]
;
; Card-number and number to dial derived from command-line.
; Call script with the dialed number as the only arguement.  Astpp-did-map will
; return a line containing info that will cut the call off before it goes over 
; the users credit limit.  The user can get over credit limit if they have 
; multiple calls going at once.  Presently the only way to stop that is to limit
; them to one call which is not a nice solution.
;
;
exten => _.X,1,AGI(astpp-did-map.agi,${EXTEN})
exten => _.X,2,GotoIf($["${CALLSTATUS}" = "0"]?60)
exten => _.X,3,GotoIf($["${CALLSTATUS}" = "1"]?70)
exten => _.X,4,GotoIf($["${CALLSTATUS}" = "2"]?80)
exten => _.X,5,SetAccount(${ACCOUNTCODE})
exten => _.X,5,Dial(IAX2,${EXTENSION}:@${USER}${TIMELIMIT}&SIP/${USER}/${EXTEN}${TIMELIMIT})
exten => _.X,7,Hangup
exten => _.X,60,Congestion ; '0' Tells them they do not have enough money
exten => _.X,61,Hangup
exten => _.X,70,Congestion '1' Bad Phone Number
exten => _.X,71,Hangup
exten => _.X,80,Congestion
exten => _.X,81,Hangup


; ASTPP VIRTUAL HOSTED PBX
; This is the start of the dialplan for ASTPP hosted PBXs.  It will require much work before it is completed.
[astpp-"pbxid"-pbx]
include => astpp-emergency
include => astpp-internal
include => astpp-services
include => astpp-"pbxid"-pbx-in
exten => 1XXNXXNXXX,1,Goto(astpp-outgoing,${EXTEN})
exten => 011.,1,Goto(astpp-outgoing,${EXTEN})

[astpp-"pbxid"-pbx-in]
exten => s,1,Set(${PBX_ID} = "pbx_id")
exten => s,n,GotoIfTime($open-$closed|$firstday-$lastday|?20) ;Mon-Fri 
exten => s,n,GotoIfTime($open-$closed|$firstday-$lastday|?20) ;Saturday
exten => s,n,GotoIfTime($open-$closed|$firstday-$lastday|?20) ;Sunday
exten => s,n,Background($PBX_ID}-incoming-closed);
exten => s,n,Voicemail() ;I need to finish this up yet
exten => s,20,Background(${PBX_ID}-incoming-open);

[astpp-internal]
exten => *15,1,Voicemailmain()
exten => 8XXXXXX,1,Dial(SIP/${EXTEN:0:3}&IAX2/${EXTEN:0:3}) ; Dial 888 followed by their Device number for local calls

[astpp-emergency]
exten => 911,1,Dial()

[astpp-services]
exten => 411,1,Dial() ; Enable this at your own risk :-)
exten => 611,1,Dial() ;This line should go to your support/sales department
